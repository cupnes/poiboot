# poiboot
UEFIを直接叩いて動作するx86_64アーキテクチャ向けの簡易ブートローダーです。

UEFI用のパーティション(GPTでフォーマットされたパーティション、あるいはFATでも可)に配置されたkernel.bin(必須)とfs.img(あれば)をメモリへロードし、kernel.binをロードした先へジャンプします。

## サポートするバイナリフォーマット
poibootはkernel.binとfs.imgというファイル名のバイナリをメモリへロードします。

それぞれのバイナリフォーマットは以下の通りです。

### kernel.bin
16バイトのヘッダと実行バイナリ本体の構成です。

先頭からのバイト数|内容
---|---
先頭16バイト|ヘッダ
17バイト目以降|実行バイナリ本体

ヘッダ(16バイト)のフォーマットは以下の通りです。

先頭からのバイト数|内容
---|---
先頭8バイト|bss領域の先頭アドレス
7バイト目以降|bss領域のサイズ

poibootは、実行バイナリ本体へジャンプする前に、ヘッダに指定されたbss領域(*1)をゼロクリアします。詳しくは後述の「動作仕様」で説明します。

(*1): 初期値がゼロあるいは初期値無しのグローバル変数や、スタティック変数が配置される領域で、実行前にゼロで初期化しておくべき領域。

### fs.img
オプショナルで、kernel.binと同じ階層にあればメモリへロードします。

このバイナリはブートローダーから扱うものではないので、どのようなバイナリフォーマットでも構いません。poibootとしては、「fs.img」という名前のバイナリをそのままメモリへロードします。

## 動作仕様
poibootの動作は以下の通りです。

### 1. kernel.binが存在するパーティションを探す
poibootはUEFIファームウェア上で動作することを想定しており、起動ディスクのUEFI用のパーティション(GPTあるいは単にFAT)に決められたパスで配置しておくことで、PC起動時にUEFI BIOSがこれを見つけて実行してくれます。(各種ファイルの配置方法は後述の「使い方」参照)

#### 外部ストレージにpoibootを入れて試す場合の注意事項
poibootを実機で試す際は、大抵、USBフラッシュメモリ等の外部ストレージに入れて試すかと思います。(やり方は後述の「使い方」で紹介します。)

その時、動作確認で使うPCのOSが既にUEFI起動している場合など、内臓HDDにUEFI用のパーティションが既に切られている際、内臓HDD側のUEFI用パーティションに「kernel.bin」という名前のファイルを置かないで下さい。

以降に理由を記載しますが、ほとんどの場合気にしなくて問題ありません。PC本体のUEFIパーティションを触ることは無いでしょうし、デフォルトで使っているなら「kernel.bin」等というファイルがパーティション直下に置かれることは無いからです。(このようなパス指定はpoiboot独自のものです。)

USBからブートするようにBIOS設定を行った上でpoibootが入ったUSBフラッシュメモリから起動すると、USBフラッシュメモリ上のpoibootが起動します。poibootが「kernel.bin」等の外部ファイルを開く際は、UEFIファームウェア側の仕様に従い、先にボリューム(Windowsで言うところの「ドライブ」)を開く必要があります。

その際、「起動している自分自身(poiboot)が配置されているボリューム」という指定はできないようで、UEFIファームウェアが認識しているUEFI用ボリュームを順に調べ、「kernel.bin」というファイルがボリューム直下に存在するボリュームを開いています。そして、poiboot.conf(設定ファイル)やfs.img等のその他のファイルは開いたボリューム直下のみを探します。

### 2. poiboot.confのロード
kernel.binとfs.imgを配置するメモリアドレス等、poibootのいくつかの挙動は設定ファイル「poiboot.conf」で変更できます。このファイルが、kernel.binと同じボリュームの同じ階層にあればロードし、無ければデフォルト値で動作します。

#### 設定できるパラメータ一覧
poiboot.confには、「=」区切りで「パラメータ名=設定値」のように設定します。なお、「=」の前後にスペースを入れないで下さい。

パラメータ名|意味|設定値のフォーマット|デフォルト値
---|---|---|---
kernel_start|kernel.binのロード先アドレス|16進数16桁(*2)(*3)|0000000000110000
stack_base|カーネルスタックベースアドレス|16進数16桁(*2)(*3)|0000000000210000
fs_start|fs.imgのロード先アドレス|16進数16桁(*2)(*3)|0000000100000000
enable_ap|AP(*4)を起動するか否か|true/false(*5)|false

「enable_ap」で「true」を指定した場合、poibootはBSPと同じくAPもカーネルへジャンプさせます。後述する「カーネルへジャンプ」と同じアドレスへジャンプさせますので、APを使う場合はカーネルへジャンプする際の引数(後述)あるいはAPICからプロセッサ番号を取得して、プロセッサ毎に処理を分岐をさせると良いです。

(*2): アルファベット部分は大文字/小文字どちらでも構いません

(*3): 例え上の位がゼロであっても、16桁は全て指定してください

(*4): 「Application Processor」で、起動時から動作しているプロセッサ(「BSP:BootStrap Processor」)を除いた残りすべてのプロセッサ。例えば、4つのプロセッサがある場合、BSP1つを除いた3つがAP。

### 3. kernel.binのロード
UEFI用のパーティション直下の「kernel.bin」というファイル名のファイルの先頭17バイト目以降(ヘッダを除いた本体)を、poiboot.confの「kernel_start」で指定された(あるいはデフォルトの)メモリアドレスへコピーします。

その後、kernel.binのヘッダに従って、bss領域の先頭アドレスからサイズ分の領域をゼロクリアします。先頭アドレスあるいはサイズがゼロの場合は何もしません。

### 4. fs.imgのロード
kernel.binと同じ階層に「fs.img」というファイルがあれば、そのバイナリをそのまま、poiboot.confの「fs_start」で指定された(あるいはデフォルトの)アドレスへロードします。

### 5. APコアの起動
poiboot.confの「enable_ap」に「true」が設定されている場合、AP側のプロセッサも、BSPと同様に、カーネル本体をロードした先頭のアドレスへジャンプさせます。

逆に「enable_ap」に「false」が指定されている場合、あるいは「enable_ap」が設定されていない場合もデフォルトの挙動として、AP側のプロセッサで何もしません。

### 6. UEFIの終了
BSPにて、「ExitBootServices()」を呼び出して、UEFIを抜けます。

### 7. カーネルへジャンプ

## 使い方
### 1. カーネルバイナリとファイルシステムイメージ(必要なら)を用意
poibootは、簡単な独自フォーマットのカーネルバイナリ(kernel.bin)とファイルシステムイメージ(fs.img)をメモリへロードします。
