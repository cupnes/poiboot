# poiboot
UEFIを直接叩いて動作するx86_64アーキテクチャ向けの簡易ブートローダーです。

UEFI用のパーティション(GPTでフォーマットされたパーティション、あるいはFATでも可)に配置されたkernel.bin(必須)とfs.img(あれば)をメモリへロードし、kernel.binをロードした先へジャンプします。

## サポートするバイナリフォーマット
poibootはkernel.binとfs.imgというファイル名のバイナリをメモリへロードします。

それぞれのバイナリフォーマットは以下の通りです。

### kernel.bin
16バイトのヘッダと実行バイナリ本体の構成です。

先頭からのバイト数|内容
---|---
先頭16バイト|ヘッダ
17バイト目以降|実行バイナリ本体

ヘッダ(16バイト)のフォーマットは以下の通りです。

先頭からのバイト数|内容
---|---
先頭8バイト|bss領域の先頭アドレス
7バイト目以降|bss領域のサイズ

poibootは、実行バイナリ本体へジャンプする前に、ヘッダに指定されたbss領域(*1)をゼロクリアします。詳しくは後述の「動作仕様」で説明します。

(*1): 初期値がゼロあるいは初期値無しのグローバル変数や、スタティック変数が配置される領域で、実行前にゼロで初期化しておくべき領域。

### fs.img
オプショナルで、kernel.binと同じ階層にあればメモリへロードします。

このバイナリはブートローダーから扱うものではないので、どのようなバイナリフォーマットでも構いません。poibootとしては、「fs.img」という名前のバイナリをそのままメモリへロードします。

## 動作仕様
poibootの動作は以下の通りです。

### 1. kernel.binが存在するパーティションを探す
poibootはUEFIファームウェア上で動作することを想定しており、起動ディスクのUEFI用のパーティション(GPTあるいは単にFAT)に決められたパスで配置しておくことで、PC起動時にUEFI BIOSがこれを見つけて実行してくれます。(各種ファイルの配置方法は後述の「使い方」参照)

#### 外部ストレージにpoibootを入れて試す場合の注意事項
poibootを実機で試す際は、大抵、USBフラッシュメモリ等の外部ストレージに入れて試すかと思います。(やり方は後述の「使い方」で紹介します。)

その時、動作確認で使うPCのOSが既にUEFI起動している場合など、内臓HDDにUEFI用のパーティションが既に切られている際、内臓HDD側のUEFI用パーティションに「kernel.bin」という名前のファイルを置かないで下さい。

以降に理由を記載しますが、ほとんどの場合気にしなくて問題ありません。PC本体のUEFIパーティションを触ることは無いでしょうし、デフォルトで使っているなら「kernel.bin」等というファイルがパーティション直下に置かれることは無いからです。(このようなパス指定はpoiboot独自のものです。)

USBからブートするようにBIOS設定を行った上でpoibootが入ったUSBフラッシュメモリから起動すると、USBフラッシュメモリ上のpoibootが起動します。poibootが「kernel.bin」等の外部ファイルを開く際は、UEFIファームウェア側の仕様に従い、先にボリューム(Windowsで言うところの「ドライブ」)を開く必要があります。

その際、「起動している自分自身(poiboot)が配置されているボリューム」という指定はできないようで、UEFIファームウェアが認識しているUEFI用ボリュームを順に調べ、「kernel.bin」というファイルがボリューム直下に存在するボリュームを開いています。そして、poiboot.conf(設定ファイル)やfs.img等のその他のファイルは開いたボリューム直下のみを探します。

### 2. poiboot.confのロード
kernel.binとfs.imgを配置するメモリアドレス等、poibootのいくつかの挙動は設定ファイル「poiboot.conf」で変更できます。このファイルが、kernel.binと同じボリュームの同じ階層にあればロードし、無ければデフォルト値で動作します。

#### 設定できるパラメータ一覧


### 3. kernel.binのロード

### 4. fs.imgのロード

### 5. APコアの起動

### 6. UEFIの終了

### 7. カーネルへジャンプ

## 使い方
### 1. カーネルバイナリとファイルシステムイメージ(必要なら)を用意
poibootは、簡単な独自フォーマットのカーネルバイナリ(kernel.bin)とファイルシステムイメージ(fs.img)をメモリへロードします。
